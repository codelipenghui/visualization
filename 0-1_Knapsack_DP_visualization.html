<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0/1 Knapsack - Dynamic Programming Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
            font-size: 0.875rem;
        }
        .main-title {
            font-size: 2.1rem; 
        }
        @media (min-width: 768px) { 
            .main-title {
                font-size: 2.5rem; 
            }
        }
        .section-title {
            color: #334155; /* slate-700 */
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem; 
            font-weight: 600;
        }
        .label-text {
            color: #475569; /* slate-600 */
            font-size: 0.8rem;
        }
        .input-field {
            background-color: #f8fafc;
            color: #1e293b;
            border: 1px solid #cbd5e1; /* slate-300 */
            padding: 0.625rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
        }
        .input-field:focus {
            border-color: #64748b; /* slate-500 */
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.2);
            outline: none;
        }
        .btn {
            padding: 0.5rem 1rem; 
            border: 1px solid #cbd5e1; 
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.75rem; 
            border-radius: 0.375rem; 
            font-weight: 500;
        }
        .btn-primary { 
             background-color: #334155; 
             color: white;
             border-color: #334155;
        }
        .btn-primary:hover {
            background-color: #1e293b; 
            border-color: #1e293b;
        }
        .btn-secondary { 
            background-color: #f1f5f9; 
            color: #334155; 
        }
        .btn-secondary:hover {
            background-color: #e2e8f0; 
        }
        .btn:disabled, .btn-secondary:disabled, .btn-primary:disabled, .btn-danger:disabled {
            background-color: #f8fafc !important; 
            color: #94a3b8 !important; 
            border-color: #e2e8f0 !important;
            cursor: not-allowed;
        }
         .btn-danger {
            background-color: #475569; 
            color: white;
            border-color: #475569;
        }
        .btn-danger:hover {
            background-color: #334155; 
            border-color: #334155;
        }
        .log-area {
            background-color: #f1f5f9; 
            border: 1px solid #e2e8f0; 
            min-height: 0;
            font-size: 0.75rem;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 0; 
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out, padding 0.5s ease-in-out;
            margin-top: 0;
            border-radius: 0.375rem;
        }
        .log-area.expanded {
            max-height: 250px; 
            opacity: 1;
            margin-top: 1rem; 
            padding: 0.75rem; 
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 0.3em;
            padding-bottom: 0.3em;
            border-bottom: 1px dashed #e2e8f0; 
        }
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .accent-slate-500 { 
             accent-color: #64748b; 
        }
        .dp-table-container {
            max-width: 100%;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background-color: #ffffff; 
        }
        .dp-table td, .dp-table th {
            border: 1px solid #e2e8f0; 
            padding: 0.4rem; 
            text-align: center;
            min-width: 45px; 
            height: 45px;
            transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
            font-size: 0.75rem; 
        }
        .dp-table th {
            color: #475569; 
            background-color: #f8fafc; 
            font-weight: 500;
            position: sticky; 
            left: 0;
            z-index: 1; 
        }
        .dp-table thead th { 
            top: 0;
            z-index: 2; 
        }
        .dp-table thead th:first-child { 
             z-index: 3; 
        }
         .dp-table th span.text-xs { 
            font-size: 0.65rem; 
            color: #64748b; 
        }
        .highlight-current { 
            background-color: #e2e8f0 !important; 
            color: #1e293b !important; 
            font-weight: 600;
            outline: 1px solid #94a3b8; 
            outline-offset: -1px;
        }
        .highlight-cannot-include {
             background-color: #f1f5f9 !important;
        }
        .highlight-dependency { 
            background-color: #f0f9ff; 
            outline: 1px dotted #bae6fd; 
        }
        .highlight-chosen-dependency { 
            background-color: #ecfdf5; 
            outline: 1px solid #a7f3d0; 
        }
        .highlight-calculated { 
            background-color: #ffffff; 
        }
        .text-item-taken-in-dp { 
            color: #057a55; 
            font-weight: 600;
        }
        .text-item-not-taken-in-dp { 
            color: #6b7280; 
        }
        .code-visualization {
            background-color: #f1f5f9; 
            border: 1px solid #e2e8f0; 
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Roboto Mono', monospace; 
            font-size: 0.75rem; 
            line-height: 1.6; 
            max-height: 0; 
            opacity: 0;
            overflow-x: auto; 
            overflow-y: hidden; 
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out;
            margin-top: 0;
        }
        .code-visualization.expanded {
            max-height: 70vh; 
            opacity: 1;
            margin-top: 1rem; 
            overflow-y: auto; 
        }
        .code-line {
            padding: 0.15rem 0.5rem; 
            border-radius: 0.125rem;
            transition: background-color 0.2s ease-in-out;
            white-space: pre; 
        }
        .python-keyword { color: #0ea5e9; }
        .python-function { color: #2563eb; }
        .python-parameters { color: #475569; }
        .python-comment { color: #64748b; font-style: italic; }
        .python-variable { color: #1e293b; }
        .python-operator { color: #ec4899; }
        .python-number { color: #f59e0b; }
        
        .highlight-code-active { background-color: #e2e8f0; }
        .highlight-code-branch { background-color: #ccfbf1; } 
        .highlight-code-prune { background-color: #fee2e2; } 
        .highlight-code-solution { background-color: #dcfce7; } 

        .collapsible-title {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-title::after {
            content: '[+]'; 
            color: #64748b; 
            font-size: 0.8em;
            margin-left: 8px;
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-title.expanded::after {
            content: '[-]'; 
        }
        .content-section { 
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06);
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }

    </style>
</head>
<body>
    <div class="container mx-auto px-4 md:px-8 py-8">
        <header class="mb-8 text-center">
            <h1 class="main-title font-bold text-slate-700">0/1 Knapsack: Dynamic Programming</h1>
            <p class="text-md text-slate-500 mt-1">Visualization</p>
        </header>

        <section id="input-section" class="content-section">
            <h2 class="section-title">Parameters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="item-weights" class="block label-text mb-1">Item Weights (csv):</label>
                    <input type="text" id="item-weights" value="10,20,30" class="input-field block w-full">
                </div>
                <div>
                    <label for="item-values" class="block label-text mb-1">Item Values (csv):</label>
                    <input type="text" id="item-values" value="60,100,120" class="input-field block w-full">
                </div>
                <div>
                    <label for="knapsack-capacity" class="block label-text mb-1">Knapsack Capacity:</label>
                    <input type="number" id="knapsack-capacity" value="50" class="input-field block w-full">
                </div>
            </div>
            <div id="input-error" class="mt-2 text-xs text-red-500"></div>
        </section>

        <section id="controls-section" class="content-section">
            <h2 class="section-title">Controls</h2>
            <div class="flex flex-wrap gap-2 items-center">
                <button id="start-btn" class="btn btn-primary">Start</button>
                <button id="step-btn" class="btn btn-secondary" disabled>Step</button>
                <button id="auto-btn" class="btn btn-secondary" disabled>Auto</button> 
                <button id="pause-btn" class="btn btn-secondary" disabled>Pause</button>
                <button id="reset-btn" class="btn btn-danger">Reset</button>
                 <div class="flex items-center md:ml-auto mt-2 md:mt-0">
                    <label for="speed-slider" class="mr-2 label-text">Speed:</label>
                    <input type="range" id="speed-slider" min="50" max="1500" value="400" step="50" class="w-24 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500">
                    <span id="speed-value" class="ml-2 text-xs text-slate-500 w-12 text-right">400ms</span>
                </div>
            </div>
        </section>
        
        <div class="flex flex-col md:flex-row gap-6 mt-6">
            <div class="md:w-3/5 space-y-6">
                 <section class="content-section">
                    <h3 class="text-lg font-semibold mb-2 text-slate-700">DP Table</h3>
                    <div id="dp-table-container" class="dp-table-container">
                        <p class="text-center text-slate-400 py-4 text-sm">DP Table will render here.</p>
                    </div>
                </section>
                <section class="content-section"> <!-- Moved Results above Log -->
                    <h3 class="section-title mb-2">Results</h3>
                    <p id="max-value-output" class="text-slate-700 text-sm">Max Value: <span class="font-semibold">-</span></p>
                    <p id="selected-items-output" class="text-slate-700 text-sm">Selected Items (1-based index): <span class="font-semibold">-</span></p>
                </section>
                <section class="content-section">
                     <h3 id="log-title" class="section-title collapsible-title">Log</h3>
                    <div id="explanation-area" class="log-area"> 
                    </div>
                </section>
            </div>

            <div class="md:w-2/5">
                <section class="content-section">
                    <h3 id="code-title" class="section-title collapsible-title expanded">Python Code (Conceptual)</h3>
                    <div id="code-visualization-area-dp" class="code-visualization expanded">
                        <div class="code-line" data-line-dp="1"><span class="python-keyword">def</span> <span class="python-function">knapsack_01_dp</span>(<span class="python-parameters">values, weights, capacity</span>):</div>
                        <div class="code-line" data-line-dp="2">  <span class="python-variable">n</span> <span class="python-operator">=</span> <span class="python-function">len</span>(<span class="python-variable">values</span>)</div>
                        <div class="code-line" data-line-dp="3">  <span class="python-variable">dp</span> <span class="python-operator">=</span> [[<span class="python-number">0</span> <span class="python-keyword">for</span> _ <span class="python-keyword">in</span> <span class="python-function">range</span>(<span class="python-variable">capacity</span> <span class="python-operator">+</span> <span class="python-number">1</span>)] <span class="python-keyword">for</span> _ <span class="python-keyword">in</span> <span class="python-function">range</span>(<span class="python-variable">n</span> <span class="python-operator">+</span> <span class="python-number">1</span>)]</div>
                        <div class="code-line" data-line-dp="4">  </div>
                        <div class="code-line" data-line-dp="5">  <span class="python-keyword">for</span> <span class="python-variable">i</span> <span class="python-keyword">in</span> <span class="python-function">range</span>(<span class="python-number">1</span>, <span class="python-variable">n</span> <span class="python-operator">+</span> <span class="python-number">1</span>):</div>
                        <div class="code-line" data-line-dp="6">    <span class="python-keyword">for</span> <span class="python-variable">w_cap</span> <span class="python-keyword">in</span> <span class="python-function">range</span>(<span class="python-number">1</span>, <span class="python-variable">capacity</span> <span class="python-operator">+</span> <span class="python-number">1</span>):</div>
                        <div class="code-line" data-line-dp="7">      <span class="python-variable">item_weight</span> <span class="python-operator">=</span> <span class="python-variable">weights</span>[<span class="python-variable">i</span><span class="python-operator">-</span><span class="python-number">1</span>]</div>
                        <div class="code-line" data-line-dp="8">      <span class="python-variable">item_value</span> <span class="python-operator">=</span> <span class="python-variable">values</span>[<span class="python-variable">i</span><span class="python-operator">-</span><span class="python-number">1</span>]</div>
                        <div class="code-line" data-line-dp="9">      </div>
                        <div class="code-line" data-line-dp="10">     <span class="python-keyword">if</span> <span class="python-variable">w_cap</span> <span class="python-operator">&lt;</span> <span class="python-variable">item_weight</span>:</div>
                        <div class="code-line" data-line-dp="11">       <span class="python-variable">dp</span>[<span class="python-variable">i</span>][<span class="python-variable">w_cap</span>] <span class="python-operator">=</span> <span class="python-variable">dp</span>[<span class="python-variable">i</span><span class="python-operator">-</span><span class="python-number">1</span>][<span class="python-variable">w_cap</span>]</div>
                        <div class="code-line" data-line-dp="12">     <span class="python-keyword">else</span>:</div>
                        <div class="code-line" data-line-dp="13">       <span class="python-variable">val_exclude</span> <span class="python-operator">=</span> <span class="python-variable">dp</span>[<span class="python-variable">i</span><span class="python-operator">-</span><span class="python-number">1</span>][<span class="python-variable">w_cap</span>]</div>
                        <div class="code-line" data-line-dp="14">       <span class="python-variable">val_include</span> <span class="python-operator">=</span> <span class="python-variable">item_value</span> <span class="python-operator">+</span> <span class="python-variable">dp</span>[<span class="python-variable">i</span><span class="python-operator">-</span><span class="python-number">1</span>][<span class="python-variable">w_cap</span> <span class="python-operator">-</span> <span class="python-variable">item_weight</span>]</div>
                        <div class="code-line" data-line-dp="15">       <span class="python-variable">dp</span>[<span class="python-variable">i</span>][<span class="python-variable">w_cap</span>] <span class="python-operator">=</span> <span class="python-function">max</span>(<span class="python-variable">val_exclude</span>, <span class="python-variable">val_include</span>)</div>
                        <div class="code-line" data-line-dp="16"> </div>
                        <div class="code-line" data-line-dp="17"> <span class="python-keyword">return</span> <span class="python-variable">dp</span>[<span class="python-variable">n</span>][<span class="python-variable">capacity</span>]</div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        var items = [];
        var W_capacity = 0;
        var N_items = 0;
        var animationSpeed = 400;
        var isSolving = false;
        var isPaused = false;
        var autoplayTimeoutId = null;
        var dp_data = []; 
        var dp_table_elements = []; 
        var animation_queue = [];
        var is_processing_queue = false; 
        var userHasScrolledDPTable = false;
        var dpTableScrollResumeTimer = null;
        const DP_TABLE_SCROLL_RESUME_DELAY = 3000; 
        var isProgrammaticDPScroll = false;

        document.addEventListener('DOMContentLoaded', () => {
            const weightsInput = document.getElementById('item-weights');
            const valuesInput = document.getElementById('item-values');
            const capacityInput = document.getElementById('knapsack-capacity');
            const startBtn = document.getElementById('start-btn');
            const stepBtn = document.getElementById('step-btn');
            const autoBtn = document.getElementById('auto-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const speedSlider = document.getElementById('speed-slider');
            const speedValueSpan = document.getElementById('speed-value');
            const dpTableContainer = document.getElementById('dp-table-container');
            const explanationArea = document.getElementById('explanation-area'); 
            const logTitle = document.getElementById('log-title');
            const codeVisualizationAreaDP = document.getElementById('code-visualization-area-dp');
            const codeTitle = document.getElementById('code-title');
            const maxValueOutput = document.getElementById('max-value-output').querySelector('span');
            const selectedItemsOutput = document.getElementById('selected-items-output').querySelector('span');
            const inputError = document.getElementById('input-error');

            function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

            function addLog(message) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = message;
                if (explanationArea && explanationArea.firstChild && explanationArea.firstChild.textContent === "Log messages will appear here...") {
                    explanationArea.innerHTML = '';
                }
                if (explanationArea) explanationArea.appendChild(entry);
                if (explanationArea) explanationArea.scrollTop = explanationArea.scrollHeight;
            }
            
            function clearCodeHighlightsDP() {
                if(codeVisualizationAreaDP) {
                    const lines = codeVisualizationAreaDP.querySelectorAll('.code-line');
                    lines.forEach(line => line.classList.remove('highlight-code-active', 'highlight-code-branch', 'highlight-code-prune', 'highlight-code-solution'));
                }
            }

            function highlightCodeLineDP(lineNumber, type = 'active') {
                clearCodeHighlightsDP();
                 if(codeVisualizationAreaDP) {
                    const line = codeVisualizationAreaDP.querySelector(`.code-line[data-line-dp="${lineNumber}"]`);
                    if (line) {
                        line.classList.add(`highlight-code-${type}`);
                    }
                }
            }

            function validateAndParseInputs() {
                const weightsStr = weightsInput.value.split(',').map(s => s.trim()).filter(s => s !== "");
                const valuesStr = valuesInput.value.split(',').map(s => s.trim()).filter(s => s !== "");
                const capStr = capacityInput.value;

                if (weightsStr.length === 0 || valuesStr.length === 0 || !capStr) {
                    if(inputError) inputError.textContent = "Error: All parameters required.";
                    return false;
                }
                if (weightsStr.length !== valuesStr.length) {
                    if(inputError) inputError.textContent = "Error: Item weights and values must have the same count.";
                    return false;
                }
                items = [];
                try {
                    const parsedWeights = weightsStr.map(Number);
                    const parsedValues = valuesStr.map(Number);
                    W_capacity = parseInt(capStr);

                    if (parsedWeights.some(isNaN) || parsedValues.some(isNaN) || isNaN(W_capacity)) {
                        if(inputError) inputError.textContent = "Error: Weights, values, and capacity must be valid numbers.";
                        return false;
                    }
                    if (parsedWeights.some(w => w <= 0) || parsedValues.some(v => v < 0) || W_capacity < 0) {
                        if(inputError) inputError.textContent = "Error: Weights must be positive. Values and capacity must be non-negative.";
                        return false;
                    }

                    for (let i = 0; i < parsedWeights.length; i++) {
                        items.push({
                            id: i + 1, 
                            original_index: i, 
                            weight: parsedWeights[i],
                            value: parsedValues[i]
                        });
                    }
                    N_items = items.length;
                } catch (e) {
                    if(inputError) inputError.textContent = "Error: Input parsing failed.";
                    return false;
                }
                
                if(inputError) inputError.textContent = "";
                return true;
            }
            
            function initializeDPTableHTML() {
                if (!dpTableContainer) return;
                dpTableContainer.innerHTML = ''; 
                const table = document.createElement('table');
                table.className = 'dp-table w-full border-collapse';
                
                const header = table.createTHead().insertRow();
                const thCorner = document.createElement('th');
                thCorner.innerHTML = 'Item<span class="text-xs text-slate-400">\\</span>Cap.';
                header.appendChild(thCorner);

                for (let j = 0; j <= W_capacity; j++) {
                    const th = document.createElement('th');
                    th.textContent = j;
                    header.appendChild(th);
                }

                dp_table_elements = [];
                const tbody = table.createTBody();
                for (let i = 0; i <= N_items; i++) { 
                    const row_elements = [];
                    const row = tbody.insertRow();
                    
                    const thItem = document.createElement('th');
                    if (i === 0) {
                        thItem.textContent = 'No Items';
                    } else {
                        thItem.innerHTML = `Item ${items[i-1].id}<br><span class="text-xs text-slate-400">(W:${items[i-1].weight},V:${items[i-1].value})</span>`;
                    }
                    row.appendChild(thItem);

                    for (let j = 0; j <= W_capacity; j++) { 
                        const cell = row.insertCell();
                        cell.textContent = (i === 0 || j === 0) ? '0' : '-';
                        if (i === 0 || j === 0) {
                            cell.classList.add('highlight-calculated', 'text-item-not-taken-in-dp');
                        } else {
                            cell.classList.add('text-slate-400');
                        }
                        row_elements.push(cell); 
                    }
                    dp_table_elements.push(row_elements);
                }
                dpTableContainer.appendChild(table);
            }
            
            function initializeAlgorithmState() { 
                if (!validateAndParseInputs()) return false;

                dp_data = Array(N_items + 1).fill(null).map(() => Array(W_capacity + 1).fill(0));
                initializeDPTableHTML(); 
                
                animation_queue = [];
                highlightCodeLineDP(5); 
                for (let i_dp_val = 1; i_dp_val <= N_items; i_dp_val++) {
                    highlightCodeLineDP(6);
                    for (let j_dp_val = 1; j_dp_val <= W_capacity; j_dp_val++) { 
                        animation_queue.push({i_dp: i_dp_val, j_dp: j_dp_val}); 
                    }
                }
                
                if(explanationArea) explanationArea.innerHTML = ''; // Use explanationArea
                addLog("--- Starting 0/1 Knapsack (Dynamic Programming) ---");
                if(maxValueOutput) maxValueOutput.textContent = "-";
                if(selectedItemsOutput) selectedItemsOutput.textContent = "-";
                clearCodeHighlightsDP();
                return true;
            }
            
            function clearCellHighlights() {
                for (let r = 0; r <= N_items; r++) {
                    for (let c = 0; c <= W_capacity; c++) {
                        if (dp_table_elements[r] && dp_table_elements[r][c]) {
                            dp_table_elements[r][c].classList.remove('highlight-current', 'highlight-dependency', 'highlight-chosen-dependency', 'highlight-cannot-include');
                        }
                    }
                }
            }

            async function processSingleDPStep() {
                if (animation_queue.length === 0 || is_processing_queue) {
                    if (animation_queue.length === 0 && isSolving) finalizeSolution_DP();
                    return animation_queue.length > 0;
                }
                is_processing_queue = true;
                if(stepBtn) stepBtn.disabled = true; 
                if(autoBtn) autoBtn.disabled = true;

                const {i_dp, j_dp} = animation_queue.shift();
                const item_actual_idx = i_dp - 1;
                const current_item_weight = items[item_actual_idx].weight;
                const current_item_value = items[item_actual_idx].value;

                clearCellHighlights();
                const currentCell = dp_table_elements[i_dp][j_dp];
                currentCell.classList.add('highlight-current');
                highlightCodeLineDP(7); 
                await sleep(animationSpeed/3);
                highlightCodeLineDP(8); 
                await sleep(animationSpeed/3);

                if (!userHasScrolledDPTable && currentCell && dpTableContainer) {
                    isProgrammaticDPScroll = true;
                    const containerRect = dpTableContainer.getBoundingClientRect();
                    const cellRect = currentCell.getBoundingClientRect();
                    const scrollLeft = dpTableContainer.scrollLeft + (cellRect.left - containerRect.left) - (containerRect.width / 2) + (cellRect.width / 2);
                    const scrollTop = dpTableContainer.scrollTop + (cellRect.top - containerRect.top) - (containerRect.height / 2) + (cellRect.height / 2);
                    dpTableContainer.scrollTo({ left: scrollLeft, top: scrollTop, behavior: 'smooth' });
                }

                let log_message = `Calculating dp[${i_dp}][${j_dp}]: Item ${items[item_actual_idx].id} (W:${current_item_weight}, V:${current_item_value}), Capacity: ${j_dp}\n`;

                highlightCodeLineDP(10); 
                await sleep(animationSpeed/2);
                if (j_dp < current_item_weight) {
                    dp_data[i_dp][j_dp] = dp_data[i_dp-1][j_dp];
                    currentCell.classList.add('highlight-cannot-include');
                    log_message += `  Item weight (${current_item_weight}) > capacity (${j_dp}). Cannot include.\n`;
                    log_message += `  dp[${i_dp}][${j_dp}] = dp[${i_dp-1}][${j_dp}] = ${dp_data[i_dp][j_dp]}`;
                    dp_table_elements[i_dp-1][j_dp].classList.add('highlight-chosen-dependency');
                    highlightCodeLineDP(11);
                } else {
                    highlightCodeLineDP(13); 
                    const value_without_current = dp_data[i_dp-1][j_dp];
                    dp_table_elements[i_dp-1][j_dp].classList.add('highlight-dependency');
                    log_message += `  Option 1 (Exclude Item ${items[item_actual_idx].id}): Value from dp[${i_dp-1}][${j_dp}] = ${value_without_current}\n`;
                    await sleep(animationSpeed/3);

                    highlightCodeLineDP(14); 
                    const value_with_current = current_item_value + dp_data[i_dp-1][j_dp - current_item_weight];
                    dp_table_elements[i_dp-1][j_dp - current_item_weight].classList.add('highlight-dependency');
                    log_message += `  Option 2 (Include Item ${items[item_actual_idx].id}): ${current_item_value} + dp[${i_dp-1}][${j_dp - current_item_weight}] = ${current_item_value} + ${dp_data[i_dp-1][j_dp - current_item_weight]} = ${value_with_current}\n`;
                    await sleep(animationSpeed/3);

                    highlightCodeLineDP(15); 
                    if (value_with_current > value_without_current) {
                        dp_data[i_dp][j_dp] = value_with_current;
                        currentCell.classList.add('text-item-taken-in-dp');
                        log_message += `  Decision: Option 2 (Include) is better. dp[${i_dp}][${j_dp}] = ${dp_data[i_dp][j_dp]}`;
                        dp_table_elements[i_dp-1][j_dp - current_item_weight].classList.add('highlight-chosen-dependency');
                        dp_table_elements[i_dp-1][j_dp - current_item_weight].classList.remove('highlight-dependency');
                        dp_table_elements[i_dp-1][j_dp].classList.remove('highlight-chosen-dependency');
                    } else {
                        dp_data[i_dp][j_dp] = value_without_current;
                        currentCell.classList.add('text-item-not-taken-in-dp');
                        log_message += `  Decision: Option 1 (Exclude) is better. dp[${i_dp}][${j_dp}] = ${dp_data[i_dp][j_dp]}`;
                        dp_table_elements[i_dp-1][j_dp].classList.add('highlight-chosen-dependency');
                        dp_table_elements[i_dp-1][j_dp].classList.remove('highlight-dependency');
                        if(dp_table_elements[i_dp-1][j_dp - current_item_weight]) {
                            dp_table_elements[i_dp-1][j_dp - current_item_weight].classList.remove('highlight-chosen-dependency');
                        }
                    }
                }
                
                currentCell.textContent = dp_data[i_dp][j_dp];
                currentCell.classList.remove('highlight-current', 'highlight-cannot-include', 'text-slate-400');
                currentCell.classList.add('highlight-calculated');
                addLog(log_message);
                await sleep(animationSpeed/2);
                
                is_processing_queue = false;
                if (animation_queue.length > 0 && isSolving) {
                    if(isPaused) {
                        if(stepBtn) stepBtn.disabled = false; 
                        if(autoBtn) autoBtn.disabled = false; 
                        if(pauseBtn) pauseBtn.disabled = true;
                    } else if (autoplayTimeoutId){
                        if(stepBtn) stepBtn.disabled = true; 
                        if(autoBtn) autoBtn.disabled = true; 
                        if(pauseBtn) pauseBtn.disabled = false;
                    }
                } else if (animation_queue.length === 0 && isSolving) {
                    finalizeSolution_DP();
                }
                return animation_queue.length > 0;
            }

            function scheduleNextAutoplayStep_DP() { 
                if (autoplayTimeoutId) clearTimeout(autoplayTimeoutId); 

                if (!isSolving || isPaused || animation_queue.length === 0) {
                    if (animation_queue.length === 0 && isSolving) {
                        finalizeSolution_DP(); 
                    }
                    if (isPaused && isSolving) {
                        if(startBtn) startBtn.disabled = true;
                        if(stepBtn) stepBtn.disabled = animation_queue.length === 0;
                        if(autoBtn) autoBtn.disabled = animation_queue.length === 0;
                        if(pauseBtn) pauseBtn.disabled = true;
                        if(resetBtn) resetBtn.disabled = false;
                    }
                    return;
                }

                autoplayTimeoutId = setTimeout(async () => {
                    try {
                        const continueSolving = await processSingleDPStep();
                        if (continueSolving && isSolving && !isPaused) { 
                            scheduleNextAutoplayStep_DP(); 
                        } else if (isSolving) { 
                            if(!isPaused && animation_queue.length === 0) { 
                                finalizeSolution_DP();
                            }
                        }
                    } catch (e) {
                        console.error("Error in DP autoplay step:", e);
                        addLog("RUNTIME ERROR in autoplay: " + e.message);
                        finalizeSolution_DP(); 
                    }
                }, animationSpeed);
            }

            function startAutoplayAnimation_DP() { 
                isPaused = false;
                addLog("--- Autoplay Resumed/Started ---");

                if(startBtn) startBtn.disabled = true;
                if(stepBtn) stepBtn.disabled = true;
                if(autoBtn) autoBtn.disabled = true;
                if(pauseBtn) pauseBtn.disabled = false;
                if(resetBtn) resetBtn.disabled = false; 

                scheduleNextAutoplayStep_DP(); 
            }

            function pauseAutoplayAnimation_DP() { 
                if (autoplayTimeoutId) clearTimeout(autoplayTimeoutId);
                autoplayTimeoutId = null;
                isPaused = true;
                addLog("--- Autoplay Paused ---");

                if (isSolving) { 
                    if(startBtn) startBtn.disabled = true;
                    if(stepBtn) stepBtn.disabled = animation_queue.length === 0;
                    if(autoBtn) autoBtn.disabled = animation_queue.length === 0;
                    if(pauseBtn) pauseBtn.disabled = true;
                    if(resetBtn) resetBtn.disabled = false;
                }
            }
            
            function findSelectedItems_DP() {
                const selected = [];
                let w = W_capacity;
                for (let i = N_items; i > 0 && w > 0; i--) {
                    if (dp_data[i][w] !== dp_data[i-1][w]) {
                        selected.push(items[i-1].id);
                        w -= items[i-1].weight;
                    }
                }
                return selected.reverse();
            }

            function finalizeSolution_DP() { 
                if (autoplayTimeoutId) clearTimeout(autoplayTimeoutId);
                autoplayTimeoutId = null;
                isSolving = false;
                isPaused = false;
                clearCellHighlights();
                highlightCodeLineDP(17, 'solution');
                
                const maxValue = dp_data[N_items][W_capacity];
                if(maxValueOutput) maxValueOutput.textContent = maxValue;
                addLog("--- 0/1 Knapsack (DP) Solved ---");
                addLog(`Max Value: ${maxValue}`);
                
                const selected = findSelectedItems_DP();
                if(selectedItemsOutput) selectedItemsOutput.textContent = selected.length > 0 ? selected.join(', ') : "None";
                addLog(`Selected Item IDs: ${selected.length > 0 ? selected.join(', ') : "None"}`);
                
                if(startBtn) startBtn.disabled = false;
                if(stepBtn) stepBtn.disabled = true; 
                if(autoBtn) autoBtn.disabled = true;
                if(pauseBtn) pauseBtn.disabled = true;
                if(resetBtn) resetBtn.disabled = false;
            }

            function resetAll() {
                if (autoplayTimeoutId) clearTimeout(autoplayTimeoutId);
                autoplayTimeoutId = null;
                isSolving = false;
                isPaused = false;
                animation_queue = [];
                is_processing_queue = false; 
                userHasScrolledDPTable = false;
                clearTimeout(dpTableScrollResumeTimer);

                if(weightsInput) weightsInput.value = "10,20,30"; 
                if(valuesInput) valuesInput.value = "60,100,120"; 
                if(capacityInput) capacityInput.value = "50";    
                if(speedSlider) speedSlider.value = "400"; 
                animationSpeed = 400;
                if(speedValueSpan) speedValueSpan.textContent = `${animationSpeed}ms`;

                if(inputError) inputError.textContent = ""; 
                if(dpTableContainer) dpTableContainer.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">DP Table will render here.</p>';
                
                if(explanationArea) explanationArea.innerHTML = ''; 
                addLog("Log messages will appear here..."); 
                clearCodeHighlightsDP();
                
                if(maxValueOutput) maxValueOutput.textContent = "-";
                if(selectedItemsOutput) selectedItemsOutput.textContent = "-";

                items = [];
                W_capacity = 0;
                N_items = 0;
                dp_data = [];
                dp_table_elements = [];

                if(startBtn) startBtn.disabled = false;
                if(stepBtn) stepBtn.disabled = true;
                if(autoBtn) autoBtn.disabled = true;
                if(pauseBtn) pauseBtn.disabled = true;
                if(resetBtn) resetBtn.disabled = false;
            }

            // Event Listeners
            if(speedSlider) speedSlider.addEventListener('input', (e) => {
                animationSpeed = parseInt(e.target.value); 
                if(speedValueSpan) speedValueSpan.textContent = `${animationSpeed}ms`;
            });
            
            if(startBtn) startBtn.addEventListener('click', () => {
                if (isSolving) return; 
                if (!initializeAlgorithmState()) return; 
                
                isSolving = true; 
                isPaused = false;
                startAutoplayAnimation_DP();
            });

            if(stepBtn) stepBtn.addEventListener('click', async () => {
                if (!isSolving) { 
                    if (!initializeAlgorithmState()) return;
                    isSolving = true; 
                }
                isPaused = true; 
                if (autoplayTimeoutId) clearTimeout(autoplayTimeoutId);
                autoplayTimeoutId = null;
                
                if(startBtn) startBtn.disabled = true;
                if(stepBtn) stepBtn.disabled = false; 
                if(autoBtn) autoBtn.disabled = false; 
                if(pauseBtn) pauseBtn.disabled = true; 
                if(resetBtn) resetBtn.disabled = false;

                const continueSolving = await processSingleDPStep();
                if (!continueSolving) {
                    // finalizeSolution_DP(); is called by processSingleDPStep
                } else { 
                    if(stepBtn) stepBtn.disabled = animation_queue.length === 0;
                    if(autoBtn) autoBtn.disabled = animation_queue.length === 0;
                }
            });

            if(autoBtn) autoBtn.addEventListener('click', () => { 
                if (!isSolving) { 
                    if (!initializeAlgorithmState()) return;
                    isSolving = true; 
                }
                startAutoplayAnimation_DP();
            });
            
            if(pauseBtn) pauseBtn.addEventListener('click', () => {
                if (isSolving && !isPaused) { 
                    pauseAutoplayAnimation_DP();
                }
            });

            if(resetBtn) resetBtn.addEventListener('click', resetAll);

            if(codeTitle) { 
                codeTitle.addEventListener('click', () => { 
                    if(codeVisualizationAreaDP) codeVisualizationAreaDP.classList.toggle('expanded'); 
                    codeTitle.classList.toggle('expanded');
                });
            }
            if(logTitle) { 
                logTitle.addEventListener('click', () => { 
                    if(explanationArea) explanationArea.classList.toggle('expanded');
                    logTitle.classList.toggle('expanded');
                });
            }
            
            if(dpTableContainer) dpTableContainer.addEventListener('scroll', () => {
                if (isProgrammaticDPScroll) {
                    isProgrammaticDPScroll = false; 
                    return; 
                }
                userHasScrolledDPTable = true;
                clearTimeout(dpTableScrollResumeTimer);
                dpTableScrollResumeTimer = setTimeout(() => {
                    userHasScrolledDPTable = false;
                }, DP_TABLE_SCROLL_RESUME_DELAY);
            });
            
            resetAll();
        });
    </script>
</body>
</html>
